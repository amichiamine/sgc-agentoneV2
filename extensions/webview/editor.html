<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>√âditeur - SGC-AgentOne</title>
    <link rel="stylesheet" href="theme/colors.css">
    <link rel="stylesheet" href="theme/fonts.css">
    <link rel="stylesheet" href="theme/syntax.css">
    <style>
        body { margin: 0; padding: 0; background: hsl(222, 84%, 5%); color: hsl(210, 40%, 95%); font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; display: flex; flex-direction: row; }
        #sidebar {
            width: 280px;
            background: hsl(215, 28%, 17%);
            border-right: 1px solid hsl(217, 19%, 20%);
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
            z-index: 10;
        }
        #sidebar-header {
            padding: 12px 16px;
            border-bottom: 1px solid hsl(217, 19%, 20%);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        #sidebar-header h3 {
            margin: 0;
            font-weight: 500;
            font-size: 0.9rem;
        }
        #tree-container {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }
        .tree-node {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            margin: 1px 0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s ease;
        }
        .tree-node:hover {
            background: hsl(215, 16%, 25%);
        }
        .tree-node.active {
            background: hsl(188, 95%, 42%);
            color: hsl(222, 84%, 5%);
        }
        .tree-icon {
            margin-right: 8px;
            width: 16px;
            text-align: center;
            font-size: 0.9rem;
            color: hsl(210, 40%, 95%);
        }
        .folder-icon {
            color: hsl(188, 95%, 42%);
        }
        .file-icon {
            color: hsl(210, 40%, 95%);
        }
        .node-label {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        #editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        #editor-toolbar {
            padding: 8px 16px;
            background: hsl(215, 28%, 17%);
            border-bottom: 1px solid hsl(217, 19%, 20%);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.9rem;
        }
        #editor-toolbar button {
            background: none;
            border: none;
            color: hsl(210, 40%, 95%);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s ease;
        }
        #editor-toolbar button:hover {
            background: hsl(215, 16%, 25%);
        }
        #editor-toolbar .filename {
            font-weight: 500;
            color: hsl(188, 95%, 42%);
            min-width: 120px;
            text-align: center;
        }
        #editor {
            flex: 1;
            background: hsl(222, 84%, 4%);
            color: hsl(210, 40%, 95%);
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            padding: 16px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            outline: none;
            resize: none;
            border: none;
            tab-size: 2;
        }
        #resize-handle {
            width: 4px;
            background: transparent;
            cursor: col-resize;
            position: relative;
            transition: background 0.2s ease;
            z-index: 20;
        }
        #resize-handle:hover {
            background: hsl(188, 95%, 42%);
        }
        #resize-handle::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 20px;
            background: hsl(217, 10%, 58%);
            border-radius: 1px;
        }
        @media (pointer: coarse) {
            #resize-handle {
                width: 12px;
            }
        }
        @media (max-width: 768px) {
            #sidebar {
                width: 0;
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 50;
                background: hsl(222, 84%, 5%);
                box-shadow: 8px 0 16px hsl(222, 84%, 2%);
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            #sidebar.active {
                transform: translateX(0);
            }
            #editor-container {
                margin-left: 0;
            }
            #toggle-sidebar {
                display: block;
                position: fixed;
                top: 8px;
                left: 8px;
                z-index: 51;
                background: hsl(215, 28%, 17%);
                border: 1px solid hsl(217, 19%, 20%);
                color: hsl(210, 40%, 95%);
                padding: 8px;
                border-radius: 4px;
                font-size: 1.2rem;
                cursor: pointer;
            }
            #resize-handle {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <div id="sidebar-header">
            <h3>üìÅ Projet</h3>
            <button id="toggle-sidebar">‚ò∞</button>
        </div>
        <div id="tree-container"></div>
    </div>

    <div id="resize-handle"></div>

    <div id="editor-container">
        <div id="editor-toolbar">
            <button id="save-btn" title="Enregistrer">üíæ</button>
            <button id="close-btn" title="Fermer">‚úñÔ∏è</button>
            <span class="filename">Aucun fichier ouvert</span>
            <button id="refresh-btn" title="Actualiser">üîÑ</button>
        </div>
        <textarea id="editor" spellcheck="false" placeholder="Ouvrez un fichier pour commencer √† √©diter..."></textarea>
    </div>

    <script>
        const treeContainer = document.getElementById('tree-container');
        const editor = document.getElementById('editor');
        const filenameEl = document.querySelector('.filename');
        const saveBtn = document.getElementById('save-btn');
        const closeBtn = document.getElementById('close-btn');
        const refreshBtn = document.getElementById('refresh-btn');
        const resizeHandle = document.getElementById('resize-handle');
        const sidebar = document.getElementById('sidebar');
        const toggleSidebarBtn = document.getElementById('toggle-sidebar');

        let currentFile = '';
        let currentPath = '';

        // Charger l'arborescence
        async function loadTree() {
            treeContainer.innerHTML = '<div style="text-align: center; color: hsl(217, 10%, 58%); padding: 32px;">Chargement...</div>';
            
            const response = await fetch('/api/files', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'listDir', path: '.' })
            });
            
            const data = await response.json();
            if (!data.success) {
                treeContainer.innerHTML = '<div style="color: hsl(310, 100%, 75%); padding: 16px;">Erreur : ' + data.error + '</div>';
                return;
            }

            treeContainer.innerHTML = '';
            renderNode(data.items, '');
        }

        // Rendu r√©cursif des n≈ìuds
        function renderNode(items, basePath) {
            items.forEach(item => {
                const node = document.createElement('div');
                node.className = 'tree-node';
                node.dataset.path = basePath + item.name;

                const icon = document.createElement('span');
                icon.className = 'tree-icon';
                icon.innerHTML = item.type === 'directory' ? 'üìÅ' : 'üìÑ';

                const label = document.createElement('span');
                label.className = 'node-label';
                label.textContent = item.name;

                node.appendChild(icon);
                node.appendChild(label);

                if (item.type === 'directory') {
                    node.addEventListener('click', () => {
                        loadSubdir(basePath + item.name);
                    });
                } else {
                    node.addEventListener('click', () => {
                        openFile(basePath + item.name);
                    });
                }

                treeContainer.appendChild(node);
            });
        }

        // Charger un sous-dossier
        async function loadSubdir(path) {
            const response = await fetch('/api/files', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'listDir', path: path })
            });

            const data = await response.json();
            if (!data.success) return;

            treeContainer.innerHTML = '';
            renderNode(data.items, path + '/');
        }

        // Ouvrir un fichier
        async function openFile(filePath) {
            const response = await fetch('/api/files', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'readFile', path: filePath })
            });

            const data = await response.json();
            if (!data.success) {
                alert('Erreur : ' + data.error);
                return;
            }

            currentFile = filePath;
            editor.value = data.content;
            filenameEl.textContent = filePath.split('/').pop();
            editor.style.display = 'block';

            // Mettre √† jour la s√©lection dans l'arbre
            document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('active'));
            const activeNode = Array.from(document.querySelectorAll('.tree-node')).find(n => n.dataset.path === filePath);
            if (activeNode) activeNode.classList.add('active');
        }

        // Enregistrer un fichier
        async function saveFile() {
            if (!currentFile) return;
            
            const content = editor.value;
            const response = await fetch('/api/files', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'createFile', path: currentFile, content: content })
            });

            const data = await response.json();
            if (data.success) {
                // Ajouter une animation de confirmation
                filenameEl.style.color = 'hsl(113, 54%, 73%)';
                setTimeout(() => {
                    filenameEl.style.color = 'hsl(188, 95%, 42%)';
                }, 1000);
            } else {
                alert('Erreur : ' + data.error);
            }
        }

        // Fermer le fichier
        function closeFile() {
            currentFile = '';
            editor.value = '';
            filenameEl.textContent = 'Aucun fichier ouvert';
            document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('active'));
        }

        // Actualiser l'arbre
        async function refreshTree() {
            loadTree();
            if (currentFile) {
                openFile(currentFile);
            }
        }

        // Gestion des √©v√©nements
        saveBtn.addEventListener('click', saveFile);
        closeBtn.addEventListener('click', closeFile);
        refreshBtn.addEventListener('click', refreshTree);

        // Sauvegarde automatique sur Ctrl+S / Cmd+S
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveFile();
            }
        });

        // Redimensionnement
        let isResizing = false;
        let startX, startWidth;

        resizeHandle.addEventListener('mousedown', (e) => {
            isResizing = true;
            startX = e.clientX;
            startWidth = sidebar.offsetWidth;
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const newWidth = startWidth + (e.clientX - startX);
            const maxW = window.innerWidth * 0.5;
            const minW = window.matchMedia('(pointer: coarse)').matches ? 250 : 200;
            sidebar.style.width = Math.max(minW, Math.min(newWidth, maxW)) + 'px';
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = 'default';
                document.body.style.userSelect = 'auto';
                
                // Sauvegarder la taille
                localStorage.setItem('sgc-panel-sizes', JSON.stringify({
                    explorer: sidebar.offsetWidth,
                    chat: null
                }));
            }
        });

        // Touches tactiles
        resizeHandle.addEventListener('touchstart', (e) => {
            isResizing = true;
            startX = e.touches[0].clientX;
            startWidth = sidebar.offsetWidth;
            e.preventDefault();
        });

        document.addEventListener('touchmove', (e) => {
            if (!isResizing) return;
            const newWidth = startWidth + (e.touches[0].clientX - startX);
            const maxW = window.innerWidth * 0.5;
            const minW = window.matchMedia('(pointer: coarse)').matches ? 250 : 200;
            sidebar.style.width = Math.max(minW, Math.min(newWidth, maxW)) + 'px';
            e.preventDefault();
        });

        document.addEventListener('touchend', () => {
            if (isResizing) {
                isResizing = false;
                navigator.vibrate(50);
                localStorage.setItem('sgc-panel-sizes', JSON.stringify({
                    explorer: sidebar.offsetWidth,
                    chat: null
                }));
            }
        });

        // Gestionnaire de menu lat√©ral mobile
        toggleSidebarBtn.addEventListener('click', () => {
            sidebar.classList.toggle('active');
        });

        // √âcoute des messages de l'explorateur
        window.addEventListener('message', (event) => {
            if (event.data.type === 'OPEN_FILE') {
                openFile(event.data.path);
                if (window.innerWidth <= 768) {
                    sidebar.classList.add('active');
                }
            }
        });

        // Charger la derni√®re taille sauvegard√©e
        const savedSizes = localStorage.getItem('sgc-panel-sizes');
        if (savedSizes) {
            const sizes = JSON.parse(savedSizes);
            if (sizes.explorer) {
                sidebar.style.width = sizes.explorer + 'px';
            }
        }

        // Initialisation
        loadTree();
    </script>
</body>
</html>
